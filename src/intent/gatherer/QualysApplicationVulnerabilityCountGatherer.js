var messages = require('../../static/messages');
var request = require("request");
var jsonic = require("jsonic");
var encodeUrl = require('encodeurl')
var qualys = require('../../helper/auth/QualysSessionHelper');

var preBody = 'callCount=1\nwindowName=\nc0-scriptName=_svc_asset_AssetQueryService\nc0-methodName=findAs\nc0-id=0\nc0-e1=string:';
var postBody = '\nc0-e2=number:0\nc0-e3=number:50\nc0-e4=string:updated\nc0-e5=boolean:false\nc0-param0=Object_Object:{query:reference:c0-e1, offset:reference:c0-e2, limit:reference:c0-e3, sort:reference:c0-e4, sortAsc:reference:c0-e5}\nrequest-template-0={"$RT$":true,"rt":["id","name","assetType","taglist","hostName","operatingSystem","lastVmScanDate","created","updated","showAllTags","nicAddresses","lastUserLoggedIn","trackingMethod","activationModules","activationModulesPending","activationModulesNoProfileFound","activationModulesQueuedManifestGen","sourceInfo"],"ct":{}}\nbatchId=53\ninstanceId=0\npage=%2Fportal-front%2Fmodule%2Fasset%2F\nscriptSessionId=jnifjbsdlfnsbsgdjskgbsldfnlsfjn\n';
var query = 'vulnerabilities.vulnerability.title:';

var options = {
  method: 'POST',
  url: 'https://qualysguard.qg1.apps.qualys.in/portal-front/dwr/call/plaincall/_svc_asset_AssetQueryService.findAs.dwr',
  headers: {
    'Postman-Token': 'f7a3ec5d-9547-496a-aeaf-0c2fab68198e',
    'Cache-Control': 'no-cache',
    Cookie: null,
    'Accept-Language': 'en-US,en;q=0.9',
    'Accept-Encoding': 'gzip, deflate, br',
    Referer: 'https://qualysguard.qg1.apps.qualys.in/portal-front/module/asset/',
    Accept: '*/*',
    'Content-Type': 'text/plain',
    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36',
    Origin: 'https://qualysguard.qg1.apps.qualys.in'
  },
  body: null
};

module.exports = function (application, callback) {
  qualys.login(function (err, sessionId) {
    if (err) throw new Error(err);
    options.body = preBody + encodeUrl(query + '"' + application + '"') + postBody;
    const speechOutput = messages.GET_FACT_MESSAGE + 'Session ID is: ' + sessionId;
    qualys.getSession(function (err, sessionCookie) {
      options.headers.Cookie = sessionCookie;
      query += '"' + application + '"';
      request(options, function (err, response, body) {
        if (err) {
          logout();
          throw new Error(err);
        }
        try {
          var root = jsonic(body.substring(body.indexOf('{metaData:{'), body.indexOf('});') + 1));
        } catch (e) {}
        logout();
        if (!root) {
          console.log('No root object parseable in reponse: ' + body);
        }
        callback(null, root ? root.total : 0);
      });
    });
  });
};

function logout() {
  qualys.logout(function (err, status) {
    if (err) throw new Error(err);
  });
}